#!/usr/bin/env python
# <*******************
#
# Copyright 2018 Juniper Networks, Inc. All rights reserved.
# Licensed under the Juniper Networks Script Software License (the "License").
# You may not use this script file except in compliance with the License, which is located at
# http://www.juniper.net/support/legal/scriptlicense/
# Unless required by applicable law or otherwise agreed to in writing by the parties, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#
# *******************>
"""
    Python module containing all NITA commands and CONSTANTS
"""

import cli as cli

# COMMANDS TREE
COMMANDS = {
    'nita': {
        'cli': {
            'version': 'echo NITA CLI master branch',
        },
        'up':       'docker-compose up -d',
        'down':     'docker-compose down',
        'new': {
            'project': 'mkdir -p {0}/build {0}/doc {0}/group_vars {0}/host_vars {0}/jenkins {0}/noob {0}/roles {0}/test/configs {0}/test/libraries {0}/test/outputs {0}/test/resource_files {0}/test/scripts {0}/test/suites {0}/test/templates {0}/test/variables_file',
            'role':    'mkdir -p {0}/defaults {0}/files {0}/handlers {0}/meta {0}/tasks {0}/templates {0}/vars ',
        },
        'containers': {
            'ls':       'docker ps --filter "label=net.juniper.framework=NITA"',
            'versions': 'docker ps -q --filter "label=net.juniper.framework=NITA" | xargs docker inspect --format "{{ .Name }} - {{ index .Config.Labels \\"net.juniper.image.release\\"}}"',
        },
        'images': {
            'ls':       'docker images --filter "label=net.juniper.framework=NITA"',
            'versions': 'docker images -q --filter "label=net.juniper.framework=NITA" | xargs docker inspect --format "{{ .RepoTags }} - {{ index .Config.Labels \\"net.juniper.image.release\\"}}"',
        },
        'ips':        'docker ps -q --filter "label=net.juniper.framework=NITA" | xargs docker inspect --format \'{{ .Name }} - {{range .NetworkSettings.Networks}}   {{.IPAddress}}{{end}}\'',
        'stats':      'docker stats --no-stream $(docker ps -q --filter "label=net.juniper.framework=NITA" --format={{.Names}})',
        'jenkins': {
            'jobs': {
                'ls':     'docker exec -it jenkins list_jenkins_jobs.py',
                'remove': 'docker exec -it jenkins remove_from_jenkins.py -y {0} {1}',
            },
            'labels':     'docker-inspect.sh jenkins',
            'cli': {
                'jenkins': 'docker exec -it -u jenkins jenkins /bin/bash',
                'root':    'docker exec -it -u root jenkins /bin/bash',
            },
            'ip':      'docker inspect --format=\'{{range .NetworkSettings.Networks}}   {{.IPAddress}}{{end}}\' jenkins',
            'ports':   'docker port jenkins',
            'volumes': 'docker inspect --format \'{{json .Mounts}}\' jenkins | jq',
            'logs':    'docker logs jenkins --tail 200',
        },
        'ansible': {
            'run': {
                'noob':  'docker run --rm --name ansible --volumes-from jenkins -v %s:/project registry.juniper.net/nita/ansible:latest ./noob.sh',
                'build': 'docker run --rm --name ansible --volumes-from jenkins -v %s:/project registry.juniper.net/nita/ansible:latest ./build.sh',
            },
            'volumes': 'docker inspect --format \'{{json .Mounts}}\' ansible | jq',
            'labels':  'docker-inspect.sh ansible',
            'cli':     'docker run -d --rm --name ansible -it --volumes-from jenkins -v %s:/project registry.juniper.net/nita/ansible:latest /bin/sh ; docker attach ansible',
        },
        'robot': {
            'run': {
                'test':    'docker run --rm --name robot --volumes-from jenkins -v %s:/project registry.juniper.net/nita/robot:latest ./test.sh',
            },
            'volumes': 'docker inspect --format \'{{json .Mounts}}\' robot | jq',
            'labels':  'docker-inspect.sh robot',
            'cli':     'docker run -d --rm --name robot -it --volumes-from jenkins -v %s:/project registry.juniper.net/nita/robot:latest /bin/bash ; docker attach robot',
        },
        'toby': {
            'run': {
                'test':    'docker run --rm --name toby -v /Users/jizquierdo/Documents/Juniper/Projects/NITA/NITA_v3.0/toby:/project -e USER="nita" -it nita/toby:1.12.1 toby -p t_object.yaml suites/common.robot',
            },
            'volumes': 'docker inspect --format \'{{json .Mounts}}\' toby | jq',
            'labels':  'docker-inspect.sh toby',
            'cli':     'docker run -d --rm --name toby -it -v /Users/jizquierdo/Documents/Juniper/Projects/NITA/NITA_v3.0/toby:/project nita/toby:1.12.1 /bin/bash ; docker attach toby',
        },
        'webapp': {
            'logs':    'docker logs webapp --tail 200',
            'ip':      'docker inspect --format=\'{{range .NetworkSettings.Networks}}   {{.IPAddress}}{{end}}\' webapp',
            'ports':   'docker port webapp',
            'volumes': 'docker inspect --format \'{{json .Mounts}}\' webapp | jq',
            'labels':  'docker-inspect.sh webapp',
            'cli':     'docker exec -it webapp /bin/bash',
        },
        'tacacs': {
            'logs':    'docker exec -it tacacs tail -200 /var/log/tacacs.log',
            'ip':      'docker inspect --format=\'{{range .NetworkSettings.Networks}}   {{.IPAddress}}{{end}}\' tacacs',
            'ports':   'docker port tacacs',
            'volumes': 'docker inspect --format \'{{json .Mounts}}\' tacacs | jq',
            'labels':  'docker-inspect.sh tacacs',
            'cli':     'docker exec -it tacacs /bin/bash',
        },
        'radius': {
            'logs':    'docker exec -it radius tail -200 /var/log/freeradius/radius.log',
            'ip':      'docker inspect --format=\'{{range .NetworkSettings.Networks}}   {{.IPAddress}}{{end}}\' radius',
            'ports':   'docker port radius',
            'volumes': 'docker inspect --format \'{{json .Mounts}}\' radius | jq',
            'labels':  'docker-inspect.sh radius',
            'cli':     'docker exec -it radius /bin/bash',
        },
        'ntp': {
            'logs':    'docker logs ntp --tail 200',
            'ip':      'docker inspect --format=\'{{range .NetworkSettings.Networks}}   {{.IPAddress}}{{end}}\' ntp',
            'ports':   'docker port ntp',
            'volumes': 'docker inspect --format \'{{json .Mounts}}\' ntp | jq',
            'labels':  'docker-inspect.sh ntp',
            'cli':     'docker exec -it ntp /bin/sh',
        },
        'dns': {
            'logs':    'docker logs dns --tail 200',
            'ip':      'docker inspect --format=\'{{range .NetworkSettings.Networks}}   {{.IPAddress}}{{end}}\' dns',
            'ports':   'docker port dns',
            'volumes': 'docker inspect --format \'{{json .Mounts}}\' dns | jq',
            'labels':  'docker-inspect.sh dns',
            'cli':     'docker exec -it dns /bin/sh',
        },
        'license':"""
# <*******************
# 
# Copyright 2018 Juniper Networks, Inc. All rights reserved.
# Licensed under the Juniper Networks Script Software License (the "License").
# You may not use this script file except in compliance with the License, which is located at
# http://www.juniper.net/support/legal/scriptlicense/
# Unless required by applicable law or otherwise agreed to in writing by the parties, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# 
# *******************>
"""
    },
}

# HELP TREE
HELP = {
    'nita': {
        'cli': {
            'version': 'Shows NITA CLI current version',
        },
        'up':   'Creates and starts NITA containers and networks.',
        'down': 'Stops and removes NITA containers and networks.',
        'new': {
            'project': 'Creates a new NITA project scaffolding.',
            'role':    'Creates a new Ansible role scaffolding.',
        },
        'containers': {
            'ls':       'Lists all running NITA containers.',
            'versions': 'Lists all running NITA containers versions.',
        },
        'images': {
            'ls':       'Lists all NITA images.',
            'versions': 'Displays NITA images versions.',
        },
        'ips':        'Shows all NITA containers IPs.',
        'stats':      'Displays NITA containers runtime metrics [CPU %, MEM USAGE / LIMIT, MEM %, NET I/O, BLOCK I/O, PIDS].',
        'jenkins': {
            'jobs': {
                'ls':     'Lists all Jenkins jobs.',
                'remove': 'Removes Jenkins jobs containing REGEX. Assume "yes" as answer to all prompts and run non-interactively.',
            },
            'labels':  'Returns labels information on jenkins container.',
            'cli': {
                'jenkins': 'Attaches local standard input, output, and error streams to jenkins running container with "jenkins" user.',
                'root':    'Attaches local standard input, output, and error streams to jenkins running container with "root" user.',
            },
            'ip':      'Returns IPs information on jenkins container.',
            'ports':   'Returns mapped ports information on jenkins container.',
            'volumes': 'Returns shared volumes information on jenkins container.',
            'logs':    'Fetches the logs of jenkins container.',
        },
        'ansible': {
            'run': {
                'noob':  'Runs NOOB process (./noob.sh script) on /project located at $PROJECT_PATH.',
                'build': 'Runs Build process (./build.sh script) on /project located at $PROJECT_PATH.',
            },
            'volumes': 'Returns shared volumes information on ansible container.',
            'labels':  'Returns labels information on ansible container.',
            'cli':     'Attaches local standard input, output, and error streams to ansible running container.',
        },
        'robot': {
            'run': {
                'test': 'Runs Test process (./test.sh script) on /project located at $PROJECT_PATH.',
            },
            'volumes': 'Returns shared volumes information on robot container.',
            'labels':  'Returns labels information on robot container.',
            'cli':     'Attaches local standard input, output, and error streams to robot running container.',
        },
        'toby': {
            'run': {
                'test': 'Runs Test process (./test.sh script) on /project located at $PROJECT_PATH.',
            },
            'volumes': 'Returns shared volumes information on toby container.',
            'labels':  'Returns labels information on toby container.',
            'cli':     'Attaches local standard input, output, and error streams to toby running container.',
        },
        'webapp': {
            'logs':    'Fetches the logs of webapp container.',
            'ip':      'Returns IPs information on webapp container.',
            'ports':   'Returns mapped ports information on webapp container.',
            'volumes': 'Returns shared volumes information on webapp container.',
            'labels':  'Returns labels information on webapp container.',
            'cli':     'Attaches local standard input, output, and error streams to webapp running container.',
        },
        'tacacs': {
            'logs':    'Fetches the logs of tacacs container.',
            'ip':      'Returns IPs information on tacacs container.',
            'ports':   'Returns mapped ports information on tacacs container.',
            'volumes': 'Returns shared volumes information on tacacs container.',
            'labels':  'Returns labels information on tacacs container.',
            'cli':     'Attaches local standard input, output, and error streams to tacacs running container.',
        },
        'radius': {
            'logs':    'Fetches the logs of radius container.',
            'ip':      'Returns IPs information on radius container.',
            'ports':   'Returns mapped ports information on radius container.',
            'volumes': 'Returns shared volumes information on radius container.',
            'labels':  'Returns labels information on radius container.',
            'cli':     'Attaches local standard input, output, and error streams to radius running container.',
        },
        'ntp': {
            'logs':    'Fetches the logs of ntp container.',
            'ip':      'Returns IPs information on ntp container.',
            'ports':   'Returns mapped ports information on ntp container.',
            'volumes': 'Returns shared volumes information on ntp container.',
            'labels':  'Returns labels information on ntp container.',
            'cli':     'Attaches local standard input, output, and error streams to ntp running container.',
        },
        'dns': {
            'logs':    'Fetches the logs of dns container.',
            'ip':      'Returns IPs information on dns container.',
            'ports':   'Returns mapped ports information on dns container.',
            'volumes': 'Returns shared volumes information on dns container.',
            'labels':  'Returns labels information on dns container.',
            'cli':     'Attaches local standard input, output, and error streams to dns running container.',
        },
        'license': 'Displays the NITA License.',
    },
}

if __name__ == '__main__':
    cli.main(COMMANDS, HELP)
